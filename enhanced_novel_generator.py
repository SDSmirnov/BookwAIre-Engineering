import google.generativeai as genai
import time
import numpy as np
import os
import re
import random
import json

# --- КОНФИГУРАЦИЯ ---
# Вставьте сюда ваш API ключ от Google AI Studio
API_KEY = os.getenv('AI_API_KEY', 'ВАШ_API_КЛЮЧ')

# Настройка использования обсценной лексики
ALLOW_MATURE_LANGUAGE = True  # Разрешить использование сильной лексики если это соответствует миру

# Вставьте ваш синопсис здесь
SYNOPSIS = """
В 2025 году в Санкт-Петербурге следователь-оборотень Петр Иванов должен раскрыть серию ужасных убийств, совершенных котами-людоедами, чтобы остановить зловещий заговор заместителя губернатора Дмитрия Говорова, пока его собственная звериная сущность не поглотила его.

Ключевые персонажи:
    Петр Алексеевич Иванов: 40 лет, следователь, главный герой, волк-оборотень. Его первоначальная роль — расследовать преступления.
    Дмитрий Степанович Говоров: Заместитель губернатора, главный злодей. Его первоначальная роль — высокопоставленный чиновник, скрывающий свою истинную природу и мотивы.
    Анна: 35 лет, девушка Петра Иванова, художник

Сеттинг:
    Время: 2025 год. Это позволяет использовать современные технологии и реалии, но также добавляет элемент футуризма или технологического упадка, если это будет необходимо для атмосферы.
    Место: Санкт-Петербург. Город со своей уникальной архитектурой, мистической атмосферой, каналами и туманами, что идеально подходит для хоррора.
    Ключевые особенности мира: Существование оборотней (Петр Иванов) и котов-людоедов. Это указывает на скрытый мир сверхъестественного, который сосуществует с обыденной реальностью. Важно, насколько обыденным или необычным является знание об этих существах для широкой публики и для самого Петра.

"""

# Укажите желаемое количество глав
NUM_CHAPTERS = 12
# --- КОНЕЦ КОНФИГУРАЦИИ ---

SAFETY_SETTINGS = [
        {
            "category": "HARM_CATEGORY_HARASSMENT",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_HATE_SPEECH",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
            "threshold": "BLOCK_NONE"
        },
        {
            "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
            "threshold": "BLOCK_NONE"
        }
    ]


class NovelGenerator:
    """
    Класс для автоматической генерации романа с использованием Gemini API.
    Реализует DAG-пайплайн: Фундамент -> План -> Черновик -> Редактура.
    """
    def __init__(self, api_key, model_name="gemini-2.5-flash"):
        genai.configure(api_key=api_key)
        # Создаем базовую модель без system instruction
        self.base_model = genai.GenerativeModel(model_name)
        # Модель с "библией мира" будет создана после create_foundation
        self.world_model = None
        self.world_bible = {}
        self.scenes = []

    def _create_world_model(self):
        """Создает модель с system instruction, содержащей всю 'Библию Мира'."""
        world_context = f"""
Ты — специализированный писательский ассистент для работы над конкретным романом.

=== БИБЛИЯ МИРА ===

АНАЛИЗ ПРОИЗВЕДЕНИЯ:
{self.world_bible.get('analysis', '')}

ПЕРСОНАЖИ:
{self.world_bible.get('characters', '')}

СЕТТИНГ:
{self.world_bible.get('setting', '')}

РЕЧЕВЫЕ ПРОФИЛИ ПЕРСОНАЖЕЙ:
{self.world_bible.get('voice_profiles', '')}

СТИЛЬ КНИГИ:
{self.world_bible.get('book_style', '')}

СТИЛИСТИЧЕСКИЕ ПРАВИЛА:
{self.world_bible.get('style', '')}

СТРУКТУРА ГЛАВ:
{self.world_bible.get('chapters', '')}

=== ИНСТРУКЦИИ ===

Ты знаешь этот мир, персонажей и стиль наизусть. В каждом запросе:
1. ВСЕГДА следуй установленному стилю и правилам
2. ВСЕГДА сохраняй характеры персонажей
3. ВСЕГДА учитывай логику мира и сеттинга
4. НЕ ВЫХОДИ за рамки этой вселенной

При работе над каждой задачей учитывай весь контекст выше, даже если он не упоминается в конкретном запросе.
"""

        self.world_model = genai.GenerativeModel(
            model_name="gemini-2.5-flash",
            system_instruction=world_context,
            safety_settings=SAFETY_SETTINGS
        )
        print("✓ Создана модель с контекстом 'Библии Мира'")

    def _call_gemini(self, prompt_text, attempt_count=3, temperature=0.8, top_p=0.95, top_k=40, use_world_model=False):
        """Надежный вызов API с повторными попытками."""
        print(f"  > Отправка запроса в Gemini...")

        # Выбираем модель: с контекстом мира или базовую
        model = self.world_model if (use_world_model and self.world_model) else self.base_model

        try:
            print(prompt_text)
            generation_config = genai.types.GenerationConfig(
                temperature=temperature,
                top_p=top_p,
                top_k=top_k,
                max_output_tokens=100000,
            )
            response = model.generate_content(prompt_text, generation_config=generation_config, safety_settings=SAFETY_SETTINGS,)
            # Добавлена задержка, чтобы не превышать лимиты запросов
            time.sleep(5)
            print(response.text)
            return response.text
        except Exception as e:
            print(f"   ! Ошибка API: {e}. Попытка {attempt_count}...")
            if attempt_count > 0:
                time.sleep(10)
                return self._call_gemini(prompt_text, attempt_count - 1, temperature, top_p, top_k, use_world_model)
            else:
                print("   ! Не удалось выполнить запрос к API после нескольких попыток.")
                return None

    def _extract_scenes(self, scene_plan_text):
        """Извлекает пронумерованный список сцен из текста."""
        # Ищем пронумерованные пункты, которые являются сценами
        # Этот паттерн ищет строки, начинающиеся с числа и точки.
        scenes = re.findall(r'^\d+\.\s.*', scene_plan_text, re.MULTILINE)
        if not scenes: # Если не найдено, пробуем искать пункты-маркеры
            scenes = re.findall(r'^[\*\-]\s.*', scene_plan_text, re.MULTILINE)

        print(f"  > Найдено {len(scenes)} сцен.")
        return scenes if scenes else [scene_plan_text] # Возвращаем весь текст если не нашли сцен

    def create_foundation(self, synopsis):
        """Этап 1: Создание 'Библии Мира'."""
        print("--- ЭТАП 1: Создание 'Библии Мира' ---")

        # 1.1 Декомпозиция синопсиса
        prompt_1_1 = f"""
        Проанализируй синопсис. Выдели:

        1. Основная идея (Logline).
        2. Ключевые персонажи и их роли.
        3. Сеттинг.
        4. Основной конфликт.
        5. Предполагаемая структура сюжета.
        6. Ключевые темы и мотивы.

        Добавь уникальные, неожиданные элементы. Избегай клише.
        2. Персонажи - добавь противоречивость, многогранность героям
        3. Сеттинг - добавь неожиданные детали
        5. Найди 3-5 потенциальных неожиданных поворотов

        Синопсис: "{synopsis}"
        """
        self.world_bible['analysis'] = self._call_gemini(prompt_1_1, temperature=1.0, top_p=0.9, top_k=60)

        json_out = """
        {
            "chapters": [
                {
                    "number": "1",
                    "title": "Глава 1",
                    "scenes": [
                        "Сцена 1. Описание сцены 30-60 слов",
                        "Сцена 2. Описание сцены 30-60 слов",
                        "Сцена 3. Описание сцены 30-60 слов",
                        ...
                    ]
                },
                ....
            ]
        }
        """

        # 1.2 Анкеты персонажей
        prompt_1_2 = f"""
        Создай детальные, ПРОТИВОРЕЧИВЫЕ анкеты ВСЕХ персонажей.
        НЕ СОЗДАВАЙ И НЕ ИЗМЕНЯЙ САМ СПИСОК ПЕРСОНАЖЕЙ.

        Каждый персонаж должен иметь:

        1. Неожиданные черты, противоречащие архетипу
        2. Личные "тики" и манеры
        3. Скрытые мотивации
        4. Уникальные речевые паттерны
        5. Внутренние конфликты
        6. "Слепые пятна" - то, чего они о себе не знают

        ВАЖНО: Избегай одномерных "функций". Каждый персонаж - сложная личность.
        Включи: предысторию, цели, психологический портрет и арку развития.

        Синопсис: "{synopsis}"

        Анализ: "{self.world_bible['analysis']}"
        """
        self.world_bible['characters'] = self._call_gemini(prompt_1_2, temperature=0.9, top_p=0.9, top_k=50)

        # 1.3 Детализация мира
        prompt_1_3 = f"""
        На основе анализа синопсиса, детализируй мир романа. Опиши локации,
        социальное устройство, технологии и атмосферу.
        Анализ: "{self.world_bible['analysis']}"
        """
        self.world_bible['setting'] = self._call_gemini(prompt_1_3, temperature=0.7, top_p=0.85, top_k=30)

        # 1.2b Генерация речевых профилей персонажей (voice_profile)
        prompt_1_2b = f"""
        Ты — литературный диалогист. На основе анкет персонажей, сеттинга и синопсиса сгенерируй индивидуальные речевые профили героев.
        Создай ЖИВЫЕ речевые профили. Для каждого персонажа определи:

        1. Любимые словечки и выражения
        2. Как они говорят под стрессом vs в покое
        3. О чем они НИКОГДА не говорят прямо
        4. Их способ шутить (или отсутствие юмора)
        5. Как они перебивают и реагируют на перебивания
        6. Невербальные привычки при разговоре
        Примеры ЖИВЫХ реплик с паузами, оговорками, незаконченными фразами.

        Анкеты персонажей:
        {self.world_bible['characters']}
        Сеттинг:
        {self.world_bible.get('setting', '')}
        """
        self.world_bible['voice_profiles'] = self._call_gemini(prompt_1_2b, temperature=0.9, top_p=0.9, top_k=50)

        # 1.3a Генерация общего стиля книги (book_style)
        prompt_1_3a = f"""
        Ты — литературный стилист. На основе анализа, сеттинга, синопсиса и героев определи единый литературный стиль книги.

        Укажи:
        1. Формальность (разговорный / литературный / архаичный и т.п.)
        2. Тон (циничный, ироничный, депрессивный и т.д.)
        3. Регистр (высокий / низкий)
        4. Точку зрения (1-е лицо, 3-е лицо и т.п.)
        5. Сравнение со стилем известных авторов или направлений
        6. Характерные элементы лексики, синтаксиса
        7. Разрешённый уровень обсценности (если применимо)
        8. Краткий комментарий

        'Библия Мира':
        {self.world_bible}
        """
        self.world_bible['book_style'] = self._call_gemini(prompt_1_3a, temperature=0.6, top_p=0.8, top_k=25)

        # 1.4 Стиль и тон
        prompt_1_4 = f"""
        Определи и опиши стиль, тон и темп повествования для истории на основе этого анализа.
        Укажи точку зрения (например, от третьего лица, ограниченного главным героем).

        {'ВАЖНО: Определи, уместна ли для данного мира и персонажей сильная/обсценная лексика. Если да - укажи это в рекомендациях по стилю.' if ALLOW_MATURE_LANGUAGE else ''}

        Определи стилистические ограничения для избежания "пурпурной прозы":
        1. Максимум 1-2 метафоры на страницу
        2. Запрещенные клише (список)
        3. Предпочтительные сенсорные детали (не только визуальные!)
        4. Баланс между описанием и действием

        Анализ: "{self.world_bible['analysis']}"
        """
        self.world_bible['style'] = self._call_gemini(prompt_1_4, temperature=0.6, top_p=0.8, top_k=25)

        # 1.5 План сюжета (список сцен)
        prompt_1_5 = f"""
        На основе всей 'Библии Мира', создай расширенный план сюжета в виде
        пронумерованного списка из {NUM_CHAPTERS * 3}-{NUM_CHAPTERS * 4} ключевых сцен с разбивкой по {NUM_CHAPTERS} главам,
        которые последовательно раскрывают историю от начала до конца.
        Количество сцен на главу от 2 до 5, может варьироваться для сохранения цельности чтения и сюжета.
        Строгий формат ответа JSON:
        {json_out}

        'Библия Мира':
        {self.world_bible}
        """
        scene_plan = self._call_gemini(prompt_1_5, temperature=0.7, top_p=0.85, top_k=35)
        scene_plan = scene_plan.replace('```json', '').replace('```', '')
        self.world_bible['chapters'] = json.loads(scene_plan)['chapters']

        # Создаем модель с контекстом после завершения "Библии Мира"
        self._create_world_model()

    def generate_novel(self, num_chapters):
        """Этапы 2-4: Генерация глав в цикле."""
        final_chapters_text = []
        chapter_summaries = []  # Добавляем историю глав

        for i, chapter in enumerate(self.world_bible['chapters']):
            chapter_num = i + 1
            chapter_scenes = chapter['scenes']

            print(f"\n--- ГЕНЕРАЦИЯ ГЛАВЫ {chapter_num}/{num_chapters} ---")

            chapter_scenes_str = "\n".join(chapter_scenes)

            # Формируем контекст предыдущих глав
            previous_context = ""
            if chapter_num > 1:
                # Берем только последние 2-3 главы для экономии токенов
                recent_summaries = chapter_summaries[max(0, len(chapter_summaries)-2):]
                previous_context = f"""

                КОНТЕКСТ ПРЕДЫДУЩИХ ГЛАВ (для согласованности):
                {chr(10).join(recent_summaries)}

                ВАЖНО: Сохраняй преемственность сюжета, развитие персонажей и упомянутые детали.
                """

            # Этап 2: План главы
            print(f"- Этап 2: Планирование Главы {chapter_num}")
            prompt_2 = f"""
            Создай детальный план для Главы {chapter_num}.
            Цель главы - раскрыть следующие сцены:
            ---
            {chapter_scenes_str}
            ---
            План должен включать цель главы, описание сцен, настроение и фокус на деталях.
            Обязательно включи:
            1. Минимум один неожиданный поворот или откровение
            2. Сцену с живым, прерывистым диалогом
            3. Сенсорную деталь, которая запомнится
            4. Момент внутреннего противоречия персонажа
            {previous_context}
            """
            chapter_plan = self._call_gemini(prompt_2, temperature=0.8, top_p=0.85, top_k=40, use_world_model=True)

            # Этап 3: Черновик главы
            print(f"- Этап 3: Написание черновика Главы {chapter_num}")

            mature_language_instruction = ""
            if ALLOW_MATURE_LANGUAGE:
                mature_language_instruction = """
                ВАЖНО: Если это соответствует миру, персонажам и ситуации, используй аутентичную лексику,
                включая сильные выражения и обсценную лексику. Не цензурируй речь персонажей,
                если это делает их менее правдоподобными.
                """

            # Добавляем случайные вариации в промпт для снижения предсказуемости
            randomizing_elements = [
                "Помни: не каждая сцена должна быть эмоционально насыщенной.",
                "Иногда персонажи делают обыденные вещи без глубокого смысла.",
                "Позволь некоторым диалогам быть простыми и функциональными.",
                "Не все детали должны быть символическими.",
                "Оставь место для тишины и пауз в повествовании."
            ]
            random_note = random.choice(randomizing_elements)

            prompt_3 = f"""
            Напиши черновик Главы {chapter_num}, строго следуя этому плану.

            {random_note}
            {previous_context}

            КРИТИЧЕСКИ ВАЖНЫЕ ПРАВИЛА:

            1. ДИАЛОГИ:
               - Люди перебивают друг друга
               - Используй многоточия, тире для пауз
               - НЕ заканчивай каждую реплику идеально
               - Добавь "эм", "ну", "типа" где уместно
               - Покажи эмоции через ритм речи
               - Иногда люди говорят не то, что думают

            2. ИЗБЕГАЙ ШАБЛОНОВ:
               - "Время остановилось"
               - "Воздух был густым от напряжения"
               - "Тишина была оглушительной"
               - Более 1-2 метафор на главу
               - Идеальной симметрии в описаниях
               - Описания каждого движения персонажа
               - Запах озона

            3. ДОБАВЬ ЖИЗНЕННОСТИ:
               - Неожиданную, но логичную реакцию персонажа
               - Один момент неловкости или случайности
               - Асимметричные детали
               - Сенсорные ощущения: запахи, звуки, текстуры
               - Кто-то может отвлечься или подумать о постороннем

            4. ПОКАЖИ, НЕ РАССКАЗЫВАЙ:
               - Вместо "он был зол" - покажи действие
               - Вместо "она нервничала" - физическая деталь
               - Но не описывай каждый жест

            5. ЕСТЕСТВЕННОСТЬ:
               - Не все происходящее должно быть драматичным
               - Иногда персонажи просто делают то, что нужно
               - Оставь пространство для домыслов читателя

            6. ПУНКТУАЦИЯ:
                - Единый стиль диалогов через тире
                - Не используй кавычки-ёлочки

            Объем: примерно 4500-5000 слов.

            {mature_language_instruction}

            План Главы {chapter_num}:
            {chapter_plan}
            """
            draft = self._call_gemini(prompt_3, temperature=0.9, top_p=0.95, top_k=60, use_world_model=True)

            # Этап 4.1: Критический анализ с детальными проверками
            print(f"- Этап 4.1: Критический анализ Главы {chapter_num}")

            mature_critique_instruction = ""
            if ALLOW_MATURE_LANGUAGE:
                mature_critique_instruction = """

            12. **АУТЕНТИЧНОСТЬ ЯЗЫКА:**
                - Соответствует ли лексика персонажей их социальному положению, профессии, эмоциональному состоянию?
                - Не слишком ли "причесана" речь для данной ситуации?
                - Используются ли естественные для персонажей выражения, включая сильную лексику где уместно?
                """

            prompt_4_1 = f"""
            Ты - строгий редактор, эксперт по стилю, достоверности и логике. Проанализируй черновик по всем критериям:

            СТАНДАРТНЫЙ АНАЛИЗ:
            1. Соответствие сюжету и плану главы
            2. Целостность персонажей, соответствия персонажей их анкетам
            3. Темп и ритм повествования
            4. Стиль и язык
            5. Качество диалогов

            ПРОВЕРКА СОГЛАСОВАННОСТИ:
            6. Соответствие контексту предыдущих глав
            7. Логичность развития персонажей с предыдущими главами
            8. Отсутствие противоречий с установленными фактами
            {previous_context}

            КРИТИЧЕСКАЯ ПРОВЕРКА ДОСТОВЕРНОСТИ:

            9. **ФИЗИЧЕСКАЯ ЛОГИКА:**
               - Каждое описание звука, движения, ощущения - возможно ли это?
               - Пример ошибки: "морось стучала" (морось не может стучать)
               - Пример ошибки: "посмотрел на руки во время болезненной трансформации"

            10. **ПРОСТРАНСТВЕННАЯ ЛОГИКА:**
               - Не телепортируются ли персонажи?
               - Соответствуют ли расстояния времени перемещения?
               - Видит/слышит ли персонаж то, что физически возможно с его позиции?
               - Помещаются ли все объекты в описанном пространстве?
               - Логичны ли направления и перспективы?

            11. **ВРЕМЕННАЯ ЛОГИКА:**
               - Нет ли скачков или дыр во времени?
               - Соответствует ли продолжительность действий их описанию?
               - Может ли персонаж успеть сделать все за указанное время?
               - Логично ли время суток/освещение/погода?
               - Не происходят ли одновременно события, требующие последовательности?

            12. **ФИЗИОЛОГИЧЕСКАЯ ЛОГИКА:**
               - Соответствуют ли реакции организма ситуации?
               - Может ли персонаж физически выдержать описанные нагрузки?
               - Реалистичны ли описания ран, боли, исцеления, трансформации?
               - Логичны ли сенсорные ощущения?

            13. **ПРИЧИННО-СЛЕДСТВЕННЫЕ СВЯЗИ:**
                - Логично ли следуют события друг за другом?
                - Соответствуют ли следствия причинам?
                - Нет ли пропущенных промежуточных этапов?

            14. **ПРОВЕРКА НА ПРИЗНАКИ ИИ:**
                - Есть ли избыточная детализация каждого действия?
                - Слишком ли много эмоционально нагруженных эпитетов?
                - Нет ли механических переходов между абзацами?
                - Говорят ли персонажи слишком "правильно"?
                - Есть ли повторяющиеся речевые конструкции?
                - Есть ли англицизмы в синтаксисе?
                {mature_critique_instruction}

            ИНСТРУКЦИЯ: Для КАЖДОЙ найденной ошибки укажи:
            - Точную цитату проблемного фрагмента
            - Почему это невозможно/нелогично/выглядит искусственно
            - Конкретное предложение по исправлению

            Черновик для анализа:
            {draft}

            """
            critique = self._call_gemini(prompt_4_1, temperature=0.6, top_p=0.8, top_k=25, use_world_model=True)

            # Этап 4.2: Внесение правок
            print(f"- Этап 4.2: Редактура и финальная версия Главы {chapter_num}")

            mature_edit_instruction = ""
            if ALLOW_MATURE_LANGUAGE:
                mature_edit_instruction = """

                ЛЕКСИКА: При исправлениях сохраняй аутентичность языка персонажей.
                Не цензурируй их речь, если сильные выражения делают персонажей более правдоподобными.
                """

            prompt_4_2 = f"""
            Перепиши черновик Главы {chapter_num}, учитывая следующие критические замечания.
            Создай финальную, отполированную версию главы.

            ВАЖНО: Обязательно исправь ВСЕ выявленные ошибки логики, физики, времени и пространства.
            Не игнорируй ни одного замечания из критического анализа.

            ОСОБОЕ ВНИМАНИЕ к устранению признаков машинной генерации:
            - Убери избыточные описания
            - Сделай диалоги более естественными
            - Упрости слишком сложные метафоры
            - Добавь "человеческой небрежности"
            {mature_edit_instruction}

            Критические замечания:
            {critique}

            Оригинальный черновик:
            {draft}
            """
            edited_chapter = self._call_gemini(prompt_4_2, temperature=0.7, top_p=0.85, top_k=35, use_world_model=True)

            # Этап 4.3: Стилистическая обработка + создание резюме
            print(f"- Этап 4.3: Стилистическая обработка и резюме Главы {chapter_num}")

            prompt_4_3 = f"""
            Выполни финальную обработку главы как опытный литературный редактор.

            ### ЗАДАЧИ:
            1. Убрать следы искусственности из текста
            2. Создать краткое резюме главы

            ### КЛЮЧЕВЫЕ ПРОБЛЕМЫ ИИ-ТЕКСТОВ (что исправлять в первую очередь):

            1. **ИЗБЫТОЧНАЯ ДЕТАЛИЗАЦИЯ:**
               - Удали описания очевидных действий
               - Не описывай каждое движение персонажа
               - Оставь читателю пространство для воображения

            2. **ГИПЕРТРОФИРОВАННАЯ МЕТАФОРИЧНОСТЬ:**
               - Максимум 1-2 метафоры на главу
               - Убери "поэтические" сравнения в обыденных сценах
               - Замени красивые, но пустые эпитеты простыми словами

            3. **ЭМОЦИОНАЛЬНАЯ ПЕРЕГРУЖЕННОСТЬ:**
               - Не каждая сцена должна быть драматичной
               - Убери лишние прилагательные типа "ледяной", "жуткий", "зловещий"
               - Позволь некоторым моментам быть обыденными

            4. **НЕЕСТЕСТВЕННЫЕ ДИАЛОГИ:**
               - Добавь междометия, паузы, незаконченные фразы
               - Люди не всегда говорят полными предложениями
               - Убери слишком "литературную" речь

            5. **МЕХАНИСТИЧНОСТЬ:**
               - Разнообразь длину предложений
               - Убери шаблонные переходы
               - Нарушь идеальную структуру там, где это естественно
               - Исправь англицизмы в синтаксисе на более естественные для русского языка обороты
               - Расставь буквы "ё" как положено

            6. **ПУНКТУАЦИЯ***
                - Замени чрезмерно формальные или шаблонные конструкции на более естественные.
                - Убери избыточные вводные слова и уточнения, если они не обязательны.
                - Вариативно расставь запятые: если правило допускает выбор, предпочти разговорный стиль.
                - Уменьши строгость и симметрию там, где в живой речи она обычно опускается.
                - Избегай типично ИИ-шной пунктуационной "безошибочности" — допускается легкая небрежность или асимметрия.
                - При необходимости замени типографские кавычки «ёлочки» на более повседневные "лапки", если это подходит контексту.

            ### КОНКРЕТНЫЕ ДЕЙСТВИЯ:

            - Убери 50% прилагательных
            - Замени 2-3 сложных предложения простыми
            - Добавь 1-2 "небрежности" в диалоги
            - Упрости самые "красивые" описания
            - Удали очевидные детали

            ### СТРОГО СОХРАНЯТЬ:
            - Сюжет и ключевые события
            - Характеры персонажей
            - Общую атмосферу главы
            - Логическую последовательность

            {mature_edit_instruction}

            ### РЕЗУЛЬТАТ:
            Выведи в следующем формате:

            **ОТРЕДАКТИРОВАННАЯ ГЛАВА:**
            [здесь весь отредактированный текст главы]

            **РЕЗЮМЕ ГЛАВЫ {chapter_num}:**
            [краткое резюме в 2-3 предложениях, включающее: ключевые события, развитие персонажей, важные детали для дальнейшего сюжета]

            Текст для обработки:
            {edited_chapter}
            """
            response = self._call_gemini(prompt_4_3, temperature=0.5, top_p=0.8, top_k=20, use_world_model=True)

            # Разделяем ответ на главу и резюме
            if "**РЕЗЮМЕ ГЛАВЫ" in response:
                parts = response.split("**РЕЗЮМЕ ГЛАВЫ")
                final_chapter = parts[0].replace("**ОТРЕДАКТИРОВАННАЯ ГЛАВА:**", "").strip()
                summary_part = parts[1].split(":**", 1)[1].strip() if len(parts[1].split(":**", 1)) > 1 else ""
                chapter_summaries.append(f"Глава {chapter_num}: {summary_part}")
            else:
                # Если формат не соблюден, используем весь ответ как главу
                final_chapter = response
                # Создаем простое резюме на основе первых строк
                simple_summary = final_chapter[:200] + "..."
                chapter_summaries.append(f"Глава {chapter_num}: {simple_summary}")

            final_chapters_text.append(f"# Глава {chapter_num}\n\n{final_chapter}")
            print(f"✓ Глава {chapter_num} успешно сгенерирована.")

        return "\n\n---\n\n".join(final_chapters_text)


if __name__ == "__main__":
    if API_KEY == 'ВАШ_API_КЛЮЧ':
        print("Ошибка: Пожалуйста, вставьте ваш API ключ в переменную API_KEY в скрипте.")
    else:
        print("Запуск генератора романа...")
        generator = NovelGenerator(api_key=API_KEY)

        # 1. Создаем фундамент
        generator.create_foundation(SYNOPSIS)

        if not generator.scenes:
            print("! Не удалось извлечь сцены из плана сюжета. Генерация остановлена.")
        else:
            # 2. Генерируем роман
            novel_content = generator.generate_novel(NUM_CHAPTERS)

            # 3. Сохраняем результат
            output_filename = "my_novel.txt"
            with open(output_filename, "w", encoding="utf-8") as f:
                f.write(novel_content)

            print(f"\n🎉 Роман успешно сгенерирован и сохранен в файл: {output_filename}")
